<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0066FF">
    <title>Fluxio</title>
    
    <style>
        /* RESET & VARIABLES */
        :root {
            --primary: #0066FF;
            --primary-light: #3385FF;
            --primary-dark: #0052CC;
            --primary-gradient: linear-gradient(135deg, var(--primary), var(--primary-light));
            --success: #00C853;
            --error: #FF4444;
            --warning: #FFAA00;
            --bg: #000000;
            --bg-elevated: #111111;
            --bg-high: #1A1A1A;
            --bg-highest: #242424;
            --border: #333333;
            --border-light: #404040;
            --text: #FFFFFF;
            --text-secondary: #AAAAAA;
            --text-tertiary: #666666;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        html, body {
            width: 100vw;
            height: 100vh;
            height: -webkit-fill-available;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* UTILITIES */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-1 { flex: 1; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .text-center { text-align: center; }
        .fullscreen { position: fixed; inset: 0; }

        /* LOADING */
        #loading {
            position: fixed;
            inset: 0;
            background: var(--primary-gradient);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeOut 0.5s 1.5s ease forwards;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }

        /* AUTH SCREEN */
        #auth {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: none;
            padding: 20px;
        }

        .auth-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 40px;
        }

        .app-brand {
            text-align: center;
        }

        .logo {
            font-size: 60px;
            margin-bottom: 16px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        .app-title {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }

        .app-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .auth-tabs {
            display: flex;
            background: var(--bg-high);
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 14px;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 20px rgba(0, 102, 255, 0.3);
        }

        .form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .input {
            width: 100%;
            height: 56px;
            padding: 0 20px;
            background: var(--bg-high);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            width: 100%;
            height: 56px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            opacity: 0.9;
            transform: scale(0.98);
        }

        /* MAIN APP */
        #app {
            position: fixed;
            inset: 0;
            display: none;
            flex-direction: column;
        }

        /* HEADER */
        .header {
            height: 64px;
            padding: 0 20px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding-top: var(--safe-top);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-center {
            flex: 1;
            text-align: center;
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--bg-high);
            color: var(--text);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
        }

        .icon-btn:active {
            background: var(--bg-highest);
        }

        /* ADD FRIEND BUTTON */
        .add-friend-btn {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 24px;
            box-shadow: 0 8px 32px rgba(0, 102, 255, 0.4);
            z-index: 90;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-friend-btn:active {
            transform: scale(0.9);
        }

        /* SIMPLE ADD MODAL */
        .simple-add-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(20px);
        }

        .simple-add-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .simple-add-card {
            background: var(--bg-elevated);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            transform: translateY(20px);
            animation: slideUp 0.3s ease forwards;
        }

        @keyframes slideUp {
            to { transform: translateY(0); }
        }

        .simple-add-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
        }

        .simple-add-subtitle {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 30px;
            font-size: 15px;
        }

        /* TWO CHOICES LAYOUT */
        .choices-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (min-width: 480px) {
            .choices-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .choice-card {
            background: var(--bg-high);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.2s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 180px;
        }

        .choice-card:active {
            background: var(--bg-highest);
            border-color: var(--primary);
        }

        .choice-card.selected {
            background: var(--bg-highest);
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }

        .choice-icon {
            width: 60px;
            height: 60px;
            background: var(--primary-gradient);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            margin-bottom: 16px;
        }

        .choice-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .choice-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* EMAIL INPUT FORM */
        .email-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 24px;
        }

        .email-input-group {
            display: flex;
            gap: 12px;
        }

        .email-input {
            flex: 1;
            height: 56px;
            padding: 0 20px;
            background: var(--bg-high);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 16px;
        }

        .email-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .send-btn {
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            transition: all 0.2s;
        }

        .send-btn:active {
            opacity: 0.9;
            transform: scale(0.95);
        }

        /* QR CODE SCANNER */
        .qr-scanner {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1100;
            display: none;
            flex-direction: column;
        }

        .qr-scanner.active {
            display: flex;
        }

        .scanner-header {
            padding: 20px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
            text-align: center;
        }

        .scanner-viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .scanner-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scanner-frame {
            width: 250px;
            height: 250px;
            border: 2px solid var(--primary);
            border-radius: 20px;
            position: relative;
        }

        .scanner-frame::before,
        .scanner-frame::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid var(--primary);
        }

        .scanner-frame::before {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
            border-radius: 20px 0 0 0;
        }

        .scanner-frame::after {
            bottom: 0;
            right: 0;
            border-left: none;
            border-top: none;
            border-radius: 0 0 20px 0;
        }

        /* MY QR CODE */
        .my-qr-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(20px);
        }

        .my-qr-modal.active {
            display: flex;
        }

        .my-qr-card {
            background: var(--bg-elevated);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 320px;
            text-align: center;
        }

        .qr-code-container {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 12px;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #333;
        }

        .user-info {
            margin-bottom: 24px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-email {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* SIDEBAR */
        #sidebar {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 200;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        #sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            height: 64px;
            padding: 0 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: var(--safe-top);
        }

        .profile {
            padding: 30px 20px;
            border-bottom: 1px solid var(--border);
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .avatar {
            width: 64px;
            height: 64px;
            background: var(--primary-gradient);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 700;
        }

        .profile-text {
            flex: 1;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-status {
            font-size: 14px;
            color: var(--success);
        }

        /* NAVIGATION */
        .nav {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px;
            background: var(--bg-high);
            border: none;
            color: var(--text);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-btn:active {
            background: var(--bg-highest);
        }

        .nav-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        /* CONTACTS LIST */
        .contacts-section {
            padding: 20px;
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title-text {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .show-qr-btn {
            padding: 8px 16px;
            background: var(--bg-high);
            color: var(--text);
            border: none;
            border-radius: 8px;
            font-size: 14px;
        }

        .contacts-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-high);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .contact-item:active {
            background: var(--bg-highest);
        }

        .contact-avatar {
            width: 48px;
            height: 48px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .contact-email {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .contact-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .chat-btn {
            background: var(--bg-highest);
            color: var(--text);
        }

        /* CHATS LIST */
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 12px;
            background: var(--bg-high);
            transition: all 0.2s;
        }

        .chat-item:active {
            background: var(--bg-highest);
        }

        .chat-avatar {
            width: 52px;
            height: 52px;
            background: var(--primary);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 600;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 16px;
        }

        .chat-time {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .chat-preview {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* NOTIFICATIONS */
        .notification {
            position: fixed;
            top: 30px;
            left: 20px;
            right: 20px;
            background: var(--bg-elevated);
            border-left: 4px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* EMPTY STATE */
        .empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        /* STATUS INDICATORS */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(0, 200, 83, 0.1);
            color: var(--success);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            background: currentColor;
            border-radius: 50%;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .simple-add-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- LOADING -->
    <div id="loading" class="flex flex-col items-center justify-center">
        <div class="loader"></div>
        <div style="margin-top: 20px; font-size: 24px; font-weight: 700; color: white;">Fluxio</div>
        <div style="margin-top: 8px; font-size: 16px; color: rgba(255,255,255,0.8);">Chargement...</div>
    </div>

    <!-- NOTIFICATIONS -->
    <div id="notifications"></div>

    <!-- AUTH -->
    <div id="auth">
        <div class="auth-container">
            <div class="app-brand">
                <div class="logo">‚ö°</div>
                <div class="app-title">Fluxio</div>
                <div class="app-subtitle">Ajouter des amis facilement</div>
            </div>
            
            <div class="auth-tabs">
                <button class="tab active" data-tab="login">Connexion</button>
                <button class="tab" data-tab="register">Inscription</button>
            </div>
            
            <form id="login-form" class="form">
                <input type="email" class="input" placeholder="Email" id="login-email" required>
                <input type="password" class="input" placeholder="Mot de passe" id="login-password" required>
                <button type="submit" class="btn">Se connecter</button>
            </form>
            
            <form id="register-form" class="form hidden">
                <input type="text" class="input" placeholder="Nom complet" id="register-name" required>
                <input type="email" class="input" placeholder="Email" id="register-email" required>
                <input type="password" class="input" placeholder="Mot de passe" id="register-password" required>
                <button type="submit" class="btn">Cr√©er un compte</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="flex flex-col">
        <!-- HEADER -->
        <div class="header">
            <div class="header-left">
                <button class="icon-btn" onclick="toggleSidebar()">‚ò∞</button>
                <div class="header-center">
                    <div class="header-title" id="current-view">Messages</div>
                </div>
            </div>
            <div class="header-right">
                <button class="icon-btn" onclick="showMyQR()">üë§</button>
                <button class="icon-btn" onclick="showAddFriendModal()">‚ûï</button>
            </div>
        </div>

        <!-- ADD FRIEND FLOATING BUTTON -->
        <button class="add-friend-btn" onclick="showAddFriendModal()">
            +
        </button>

        <!-- MAIN CONTENT -->
        <div class="flex-1">
            <!-- EMPTY STATE -->
            <div id="empty-state" class="empty">
                <div class="empty-icon">üë§</div>
                <div class="empty-title">Aucun ami</div>
                <div class="empty-text">Ajoutez des amis pour commencer √† discuter</div>
                <button class="btn" onclick="showAddFriendModal()" style="width: auto; padding: 0 32px;">
                    Ajouter un ami
                </button>
            </div>

            <!-- CHATS LIST -->
            <div id="chats-container" class="chats-list hidden">
                <!-- Chats loaded here -->
            </div>

            <!-- CONTACTS VIEW -->
            <div id="contacts-view" class="hidden">
                <div class="contacts-section">
                    <div class="section-title">
                        <div class="section-title-text">Mes amis</div>
                        <button class="show-qr-btn" onclick="showMyQR()">
                            Mon QR Code
                        </button>
                    </div>
                    <div class="contacts-list" id="friends-list">
                        <!-- Friends loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar">
        <div class="sidebar-header">
            <div style="font-size: 20px; font-weight: 700;">Menu</div>
            <button class="icon-btn" onclick="toggleSidebar()">‚úï</button>
        </div>
        
        <div class="profile">
            <div class="profile-info">
                <div class="avatar" id="user-avatar">U</div>
                <div class="profile-text">
                    <div class="profile-name" id="user-name">Utilisateur</div>
                    <div class="profile-status" id="user-status">
                        <span class="status-badge">En ligne</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="nav">
            <button class="nav-btn" onclick="showChats()">
                <span class="nav-icon">üí¨</span>
                Messages
            </button>
            <button class="nav-btn" onclick="showContacts()">
                <span class="nav-icon">üë•</span>
                Amis
            </button>
            <button class="nav-btn" onclick="showAddFriendModal()">
                <span class="nav-icon">‚ûï</span>
                Ajouter un ami
            </button>
        </div>
    </div>

    <!-- SIMPLE ADD MODAL -->
    <div class="simple-add-modal" id="add-friend-modal">
        <div class="simple-add-card">
            <h2 class="simple-add-title">Ajouter un ami</h2>
            <p class="simple-add-subtitle">Choisissez une m√©thode</p>
            
            <div class="choices-grid">
                <div class="choice-card" id="qr-choice" onclick="selectChoice('qr')">
                    <div class="choice-icon">üì±</div>
                    <div class="choice-title">Scanner QR Code</div>
                    <div class="choice-desc">Scannez le code QR d'un ami</div>
                </div>
                
                <div class="choice-card" id="email-choice" onclick="selectChoice('email')">
                    <div class="choice-icon">‚úâÔ∏è</div>
                    <div class="choice-title">Ajouter par email</div>
                    <div class="choice-desc">Entrez l'email de votre ami</div>
                </div>
            </div>

            <!-- EMAIL FORM (hidden by default) -->
            <div id="email-form-container" class="hidden">
                <div class="email-form">
                    <div class="email-input-group">
                        <input type="email" 
                               class="email-input" 
                               id="friend-email"
                               placeholder="Email de votre ami"
                               required>
                        <button class="send-btn" onclick="addByEmail()" id="send-email-btn">
                            ‚Üë
                        </button>
                    </div>
                    <p style="font-size: 13px; color: var(--text-secondary); text-align: center;">
                        Un lien d'invitation sera envoy√© √† cet email
                    </p>
                </div>
            </div>

            <!-- ACTION BUTTONS -->
            <div id="action-buttons">
                <button class="btn" style="margin-top: 16px;" onclick="hideAddFriendModal()">
                    Annuler
                </button>
                <button class="btn" style="margin-top: 12px;" onclick="continueWithChoice()" id="continue-btn">
                    Continuer
                </button>
            </div>
        </div>
    </div>

    <!-- QR CODE SCANNER -->
    <div class="qr-scanner" id="qr-scanner">
        <div class="scanner-header">
            <div style="font-size: 18px; font-weight: 600;">Scanner QR Code</div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;">
                Pointez la cam√©ra vers le code QR de votre ami
            </div>
        </div>
        
        <div class="scanner-viewport">
            <div class="scanner-overlay">
                <div class="scanner-frame"></div>
            </div>
        </div>
        
        <div style="padding: 20px;">
            <button class="btn" onclick="hideQRScanner()">
                Annuler
            </button>
        </div>
    </div>

    <!-- MY QR CODE MODAL -->
    <div class="my-qr-modal" id="my-qr-modal">
        <div class="my-qr-card">
            <div class="user-info">
                <div class="user-name" id="qr-user-name">Utilisateur</div>
                <div class="user-email" id="qr-user-email">email@exemple.com</div>
            </div>
            
            <div class="qr-code-container" id="qr-code-display">
                <!-- QR Code would be generated here -->
                <div style="font-size: 14px; color: #666;">
                    QR Code de<br>
                    <span id="qr-code-content">fluxio:user@123</span>
                </div>
            </div>
            
            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;">
                Partagez ce code avec vos amis pour qu'ils puissent vous ajouter
            </p>
            
            <button class="btn" onclick="hideMyQR()">
                Fermer
            </button>
        </div>
    </div>

    <script>
        // APPLICATION STATE
        const App = {
            // State
            user: null,
            friends: new Map(),
            selectedChoice: null,
            
            // Initialize
            init() {
                this.setupEventListeners();
                this.loadData();
                this.checkAuth();
            },
            
            // Authentication
            checkAuth() {
                const session = localStorage.getItem('fluxio_session');
                if (session) {
                    try {
                        const { userId } = JSON.parse(session);
                        const userData = localStorage.getItem(`fluxio_user_${userId}`);
                        
                        if (userData) {
                            this.user = JSON.parse(userData);
                            this.showApp();
                            return;
                        }
                    } catch (e) {}
                }
                this.showAuth();
            },
            
            login(email, password) {
                const users = JSON.parse(localStorage.getItem('fluxio_users') || '[]');
                const user = users.find(u => u.email === email && u.password === password);
                
                if (!user) {
                    this.showNotification('Identifiants incorrects', 'error');
                    return false;
                }
                
                this.user = user;
                localStorage.setItem('fluxio_session', JSON.stringify({
                    userId: user.id,
                    timestamp: Date.now()
                }));
                
                this.showApp();
                this.showNotification('Connect√© avec succ√®s');
                return true;
            },
            
            register(name, email, password) {
                const users = JSON.parse(localStorage.getItem('fluxio_users') || '[]');
                
                if (users.some(u => u.email === email)) {
                    this.showNotification('Cet email est d√©j√† utilis√©', 'error');
                    return false;
                }
                
                // Generate QR code data
                const userId = 'user_' + Date.now();
                const qrData = `fluxio:${userId}:${email}`;
                
                const user = {
                    id: userId,
                    name,
                    email,
                    password,
                    avatarColor: this.getRandomColor(),
                    qrCode: qrData,
                    createdAt: Date.now(),
                    friends: []
                };
                
                users.push(user);
                localStorage.setItem('fluxio_users', JSON.stringify(users));
                this.user = user;
                
                localStorage.setItem('fluxio_session', JSON.stringify({
                    userId: user.id,
                    timestamp: Date.now()
                }));
                
                this.showApp();
                this.showNotification('Compte cr√©√© avec succ√®s');
                return true;
            },
            
            // Data Management
            loadData() {
                try {
                    if (this.user) {
                        const savedFriends = localStorage.getItem(`fluxio_friends_${this.user.id}`);
                        if (savedFriends) {
                            JSON.parse(savedFriends).forEach(f => {
                                this.friends.set(f.id, f);
                            });
                        }
                    }
                } catch (e) {
                    console.log('Erreur chargement donn√©es');
                }
            },
            
            saveData() {
                try {
                    if (this.user) {
                        localStorage.setItem(`fluxio_friends_${this.user.id}`, 
                            JSON.stringify(Array.from(this.friends.values())));
                        localStorage.setItem(`fluxio_user_${this.user.id}`, 
                            JSON.stringify(this.user));
                    }
                } catch (e) {
                    console.log('Erreur sauvegarde');
                }
            },
            
            // Friend Management
            addFriendByEmail(email) {
                if (!email || !this.validateEmail(email)) {
                    this.showNotification('Email invalide', 'error');
                    return false;
                }
                
                // Check if already friends
                const existingFriend = Array.from(this.friends.values()).find(f => f.email === email);
                if (existingFriend) {
                    this.showNotification('D√©j√† ami avec cette personne', 'error');
                    return false;
                }
                
                // Check if it's yourself
                if (email === this.user.email) {
                    this.showNotification('Vous ne pouvez pas vous ajouter vous-m√™me', 'error');
                    return false;
                }
                
                // Simulate sending invitation
                this.showNotification(`Invitation envoy√©e √† ${email}`);
                
                // Simulate finding user in database
                setTimeout(() => {
                    const users = JSON.parse(localStorage.getItem('fluxio_users') || '[]');
                    const foundUser = users.find(u => u.email === email);
                    
                    if (foundUser) {
                        // User exists - add as friend
                        this.addFoundFriend(foundUser);
                    } else {
                        // User doesn't exist - show invitation sent message
                        this.showNotification(`${email} recevra une invitation`);
                    }
                }, 1000);
                
                return true;
            },
            
            addFoundFriend(friendData) {
                const friend = {
                    id: friendData.id,
                    name: friendData.name,
                    email: friendData.email,
                    avatarColor: friendData.avatarColor || this.getRandomColor(),
                    addedAt: Date.now()
                };
                
                this.friends.set(friend.id, friend);
                this.saveData();
                this.loadFriends();
                
                this.showNotification(`${friend.name} ajout√© √† vos amis`);
                this.hideAddFriendModal();
            },
            
            addFriendByQR(qrData) {
                try {
                    // Parse QR data format: fluxio:user_id:email
                    const parts = qrData.split(':');
                    if (parts[0] !== 'fluxio' || parts.length < 3) {
                        this.showNotification('QR Code invalide', 'error');
                        return false;
                    }
                    
                    const userId = parts[1];
                    const email = parts[2];
                    
                    // Check if already friends
                    if (this.friends.has(userId)) {
                        this.showNotification('D√©j√† ami avec cette personne', 'error');
                        return false;
                    }
                    
                    // Check if it's yourself
                    if (userId === this.user.id) {
                        this.showNotification('Vous ne pouvez pas vous ajouter vous-m√™me', 'error');
                        return false;
                    }
                    
                    // Find user in database
                    const users = JSON.parse(localStorage.getItem('fluxio_users') || '[]');
                    const foundUser = users.find(u => u.id === userId);
                    
                    if (foundUser) {
                        this.addFoundFriend(foundUser);
                        return true;
                    } else {
                        this.showNotification('Utilisateur non trouv√©', 'error');
                        return false;
                    }
                } catch (e) {
                    this.showNotification('QR Code invalide', 'error');
                    return false;
                }
            },
            
            // Helper Methods
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            getRandomColor() {
                const colors = ['#0066FF', '#FF3366', '#00C853', '#FFAA00', '#9966FF'];
                return colors[Math.floor(Math.random() * colors.length)];
            },
            
            // UI Methods
            showAuth() {
                setTimeout(() => {
                    $('#loading').classList.add('hidden');
                    $('#auth').style.display = 'block';
                }, 500);
            },
            
            showApp() {
                setTimeout(() => {
                    $('#loading').classList.add('hidden');
                    $('#app').style.display = 'flex';
                    this.updateUserInfo();
                    this.loadFriends();
                    this.showNotification('Bienvenue sur Fluxio');
                }, 500);
            },
            
            updateUserInfo() {
                if (!this.user) return;
                
                $('#user-name').textContent = this.user.name;
                $('#user-avatar').textContent = this.user.name.charAt(0).toUpperCase();
                $('#user-avatar').style.background = this.user.avatarColor;
                
                // Update QR modal
                $('#qr-user-name').textContent = this.user.name;
                $('#qr-user-email').textContent = this.user.email;
                $('#qr-code-content').textContent = this.user.qrCode || `fluxio:${this.user.id}:${this.user.email}`;
            },
            
            loadFriends() {
                const container = $('#friends-list');
                
                if (this.friends.size === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">üë•</div>
                            <div style="color: var(--text-secondary); margin-bottom: 16px;">
                                Vous n'avez pas encore d'amis
                            </div>
                            <button class="btn" onclick="showAddFriendModal()" 
                                    style="width: auto; padding: 12px 24px; font-size: 14px;">
                                Ajouter un ami
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = Array.from(this.friends.values()).map(friend => `
                    <div class="contact-item">
                        <div class="contact-avatar" style="background: ${friend.avatarColor}">
                            ${friend.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="contact-info">
                            <div class="contact-name">${friend.name}</div>
                            <div class="contact-email">${friend.email}</div>
                        </div>
                        <div class="contact-actions">
                            <button class="chat-btn action-btn" onclick="App.startChat('${friend.id}')">
                                üí¨
                            </button>
                        </div>
                    </div>
                `).join('');
            },
            
            startChat(friendId) {
                const friend = this.friends.get(friendId);
                if (!friend) return;
                
                this.showNotification(`Discussion d√©marr√©e avec ${friend.name}`);
                // In a real app, this would open a chat window
                showChats(); // Go back to chats view
            },
            
            showNotification(message, type = '') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                $('#notifications').appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 10);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            },
            
            vibrate() {
                if (navigator.vibrate) {
                    navigator.vibrate(30);
                }
            },
            
            // Choice Selection
            selectChoice(choice) {
                this.selectedChoice = choice;
                
                // Update UI
                document.querySelectorAll('.choice-card').forEach(card => {
                    card.classList.remove('selected');
                });
                $(`${choice}-choice`).classList.add('selected');
                
                // Show appropriate form
                if (choice === 'email') {
                    $('#email-form-container').classList.remove('hidden');
                    $('#continue-btn').classList.add('hidden');
                    $('#friend-email').focus();
                } else {
                    $('#email-form-container').classList.add('hidden');
                    $('#continue-btn').classList.remove('hidden');
                }
            },
            
            // Event Listeners
            setupEventListeners() {
                // Auth forms
                $('#login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = $('#login-email').value.trim();
                    const password = $('#login-password').value.trim();
                    this.login(email, password);
                });
                
                $('#register-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = $('#register-name').value.trim();
                    const email = $('#register-email').value.trim();
                    const password = $('#register-password').value.trim();
                    this.register(name, email, password);
                });
                
                // Auth tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        $('#login-form').classList.toggle('hidden', tabName !== 'login');
                        $('#register-form').classList.toggle('hidden', tabName !== 'register');
                    });
                });
                
                // Email input
                $('#friend-email').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addByEmail();
                    }
                });
            }
        };

        // DOM Helper
        const $ = (id) => document.getElementById(id);

        // Initialize App
        window.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

        // Global Functions
        window.toggleSidebar = function() {
            $('#sidebar').classList.toggle('open');
        };

        // Add Friend Modal
        let selectedChoice = null;

        window.showAddFriendModal = function() {
            selectedChoice = null;
            $('#add-friend-modal').classList.add('active');
            resetChoices();
        };

        window.hideAddFriendModal = function() {
            $('#add-friend-modal').classList.remove('active');
            selectedChoice = null;
            resetChoices();
        };

        window.selectChoice = function(choice) {
            selectedChoice = choice;
            App.selectChoice(choice);
        };

        window.continueWithChoice = function() {
            if (!selectedChoice) {
                App.showNotification('Choisissez une m√©thode', 'error');
                return;
            }
            
            if (selectedChoice === 'qr') {
                hideAddFriendModal();
                showQRScanner();
            }
        };

        window.addByEmail = function() {
            const email = $('#friend-email').value.trim();
            if (App.addFriendByEmail(email)) {
                $('#friend-email').value = '';
            }
        };

        function resetChoices() {
            document.querySelectorAll('.choice-card').forEach(card => {
                card.classList.remove('selected');
            });
            $('#email-form-container').classList.add('hidden');
            $('#continue-btn').classList.remove('hidden');
            $('#friend-email').value = '';
        }

        // QR Scanner
        window.showQRScanner = function() {
            $('#qr-scanner').classList.add('active');
            
            // Simulate QR scanning
            setTimeout(() => {
                // Generate mock QR data
                const mockUsers = [
                    { id: 'user_123', email: 'jean@exemple.com', name: 'Jean Dupont' },
                    { id: 'user_456', email: 'marie@exemple.com', name: 'Marie Martin' },
                    { id: 'user_789', email: 'pierre@exemple.com', name: 'Pierre Bernard' }
                ];
                
                const randomUser = mockUsers[Math.floor(Math.random() * mockUsers.length)];
                const qrData = `fluxio:${randomUser.id}:${randomUser.email}`;
                
                hideQRScanner();
                App.addFriendByQR(qrData);
            }, 2000);
        };

        window.hideQRScanner = function() {
            $('#qr-scanner').classList.remove('active');
        };

        // My QR Code
        window.showMyQR = function() {
            if (!App.user) return;
            
            // Update QR content
            const qrData = App.user.qrCode || `fluxio:${App.user.id}:${App.user.email}`;
            $('#qr-code-content').textContent = qrData;
            
            $('#my-qr-modal').classList.add('active');
        };

        window.hideMyQR = function() {
            $('#my-qr-modal').classList.remove('active');
        };

        // Navigation
        window.showChats = function() {
            $('#current-view').textContent = 'Messages';
            $('#contacts-view').classList.add('hidden');
            $('#empty-state').classList.add('hidden');
            $('#chats-container').classList.remove('hidden');
            toggleSidebar();
        };

        window.showContacts = function() {
            $('#current-view').textContent = 'Amis';
            $('#chats-container').classList.add('hidden');
            $('#empty-state').classList.add('hidden');
            $('#contacts-view').classList.remove('hidden');
            App.loadFriends();
            toggleSidebar();
        };

        // Expose App globally
        window.App = App;
    </script>
</body>
</html>
